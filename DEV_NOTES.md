# Development Notes

## System Object Descriptions

At its heart, Inscriptio is an application for keeping track of [Reservations](app/models/reservation.rb) of [Assets](app/models/reservable_asset.rb) made by [Users](app/models/user.rb).  The [Assets](app/models/reservable_asset.rb) exist on [Floors](app/models/floor.rb) in [Libraries](app/models/library.rb). There are Type objects for Users and Assets and a few other subsidiary objects. Access is handled via Devise and CanCan.

An autogenerated diagram is available [here](doc/models.png), courtesy of [RailRoady](http://github.com/preston/railroady).  It is accurate as of 9e6004931c7768cd85567b297f55ceac56cd9f7b.

## Application Workflow

Inscriptio's workflow essentially boils down to Reservations going through a list of Statuses, generating notification emails on each change of status.  A slightly simplified summary of this flow follows.

  0. Administrators create system objects.  Libraries, Floors, ReservableAssetTypes, UserTypes, etc.  They upload a map for each floor, and associate ReservableAssets with rectangular spaces on said maps via an in-browser interface.
  1. Administrators add Users to the system and assign them types.
  2. Users, by means of the JS-enabled floor maps, select a ReservableAsset and request a Reservation. It is created, and its Status is set to one of two statuses, depending on if moderation is required:
    1. `Approved` (if moderation is not required)
    2. `Pending` (if moderation is required)
  3. Admins approve reservations (if moderation is required)
  4. In the fullness of time, reservations enter the `Expiring` status, and an "Expiring Soon" notification email is sent out.
  5. If the User renews, their reservation enters either the `Approved` or `Renewal Confirmation` status, depending, as always, on if moderation is required.
  6. If not, their Reservation becomes `Expired`, and an administrator clears it out, which soft deletes the record.

## Git Workflow Conventions
At any point in time, there are several git branches that can be meaningful to general developers.

| Branch | Description |
| ------ | ----------- |
| master | Stable branch.  We tag releases for internal purposes, but the tip of master should be considered stable at all times. |
| dev    | Development branch. New work should generally be rebased onto the tip of this; all code goes into dev before being merged into master. |
| ltsinscrip-N<sub><a href="#fn-1" name="tg-1">1</a></sub> | Topic branches. These are feature branches being worked on by Harvard devs.  They should NOT have work based on them; they are subject to rebase/deletion at any time. |

All changes propagate, ideally, in one of two fashions:
  * topic branch → dev → master
  * pull request → dev → master

Summary - anything other than `dev` or `master` can be rebased or deleted at any time.

## Unusual gems and extensions
Inscriptio is, by and large, a pretty normal Rails app, and a general familiarity with Ruby and Rails should be enough to get you going.  There are a few quirks that developers should be aware of before starting; most of which concern extensions to ActiveRecord.

### [Paranoia](https://github.com/radar/paranoia)
Inscriptio makes fairly extensive use of [Paranoia](https://github.com/radar/paranoia), a gem that provides "soft-delete" of ActiveRecord records.  Any model with `acts_as_paranoid` in its `model.rb` file and a `deleted_at` column in its table has this active.

It's important to understand the ramifications this has for associations with `:dependent => :destroy` relationships.  Any "parent" model that has a `:dependent => :destroy` with a paranoid "child" model MUST also be paranoid, otherwise referential integrity constraints will prevent deletion of the parent.

One thing to especially watch out for - [Paranoia](https://github.com/radar/paranoia) uses a default scope to hide soft-deleted records.  I suggest at minimum reading through the readme for [Paranoia](https://github.com/radar/paranoia) before doing any work in models or at the Rails console.

### pluck_all
In versions of Rails < 4, the `pluck` method can only be used on a single column.  Inscriptio uses an initializer located at `ROOT/config/pluck_all.rb` to add a `pluck_all` method to the `ActiveRecord::Relation` and `ActiveRecord::Base` classes, to allow convenient memory-efficient operations on multiple columns.

The basic code is taken from [here](http://meltingice.net/2013/06/11/pluck-multiple-columns-rails/), and wrapped in an `ActiveSupport::Concern`

Documentation for Rails 3.2 API objects and methods can be found here: http://rails.documentation.codyrobbins.com/3.2.13/

## Git Integration

A git pre-commit hook is provided whose purpose is to keep those pesky 'console.log' and 'binding.pry' statements  out of the repository.

To install:

```Shell
  ln -s /path/to/Inscriptio/pre-commit.sh .git/hooks/pre-commit
```

You can suppress the pre-commit hook by doing:

```Shell
  git commit --no-verify
```

... but in general, don't.

---

<a href="#tg-1" name="fn-1">1</a> - Where N is a number.
